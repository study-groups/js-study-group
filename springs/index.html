<html>
<head>
<link rel="icon" href="data:;base64,iVBORw0KGgo="> 
<style>
div { margin:0; padding:0; } /* one line CSS reset */
html {height:100%; font-size:30pt; }
body {height:100%; margin:0 0 0 0; padding:0 0 25% 0;}
main { height:80%;  margin:0; padding:0;}
header {height:10%; margin:0; padding:0;}
footer {height:10%; margin:0; padding:0;}
/* body includes all visible html */

body{
  background:#eee;
  /* flex-direction:column; */
}
/* mobile first, fix display, no scrolling when small. */
html, body{
    font-size:26pt;
    overflow-x: hidden;
    overflow-y: hidden;
    position: fixed;
}


/* Desktop */
@media only screen and (min-width: 720px){
html{
  font-size:18pt;
}
html, body{
    position: static;
  overflow-x: visible;
  overflow-y: visible;
}

body {
  background:yellow;
}
}

header{
  background:#ccc;
}
/* main is in body, after header, before footer */
main {
}

fieldset {
  margin:0;
  padding:0;
  width:100%;
}

.slider{
  display:flex;
  width:100%;
  margin:0;
  padding:0;
  justify-content: space-between;
  border: 1px solid #808;
}

.slider label{
  min-width:10%;
  text-align:left;
}

.slider .rangeDisplay {
  min-width:10%;
  text-align:right;
}


.slider input[type=range] {
 -webkit-appearance: none;
 background:transparent;
  flex-grow:2;
}

.wavemachine{
  display: flex;
  align-items: center;
  margin:0;
  padding:0;
  justify-content: center;
  border: 1px solid blue;
  width:100%;
}


#controller {
  align-items: center;
  justify-content: center;
  flex-direction:row;
  margin:0;
  padding:0;
  width:100%;
  min-height:100%;
  border: 1px solid green;
}

#mapper {
  min-height:3rem;
  border: 1px solid orange;
  font-family:monospace;
  white-space: pre;
  display:block;
}

#mapper h3 {
  margin:0;
  padding:0; 
}

nom-mapper: {
  display:block;
  border:1px solid red;
}

footer {
  display:flex;
  flex-direction:column;
  align-items:center;
  font-family:monospace;
  position:fixed;
  bottom:0;
  width:100%;
  background:#bbb;
  text-align:center;
  height: 2.5rem;           /* Footer height */
}


</style>
</head>
<body>
<main role="main">
    <header>
      <a href="#wavemachine">Wave Machine</a>
      <a href="#" onclick="about()">about</a>
    </header>
    <p id="about" style="display:none">
      The <a href="">harmonic oscillator</a> relates 
      <b>mass</b> and <b>restorative force</b>
      of a bounded sytem to it's <b>period of oscillation</b>. 
    </p>
    <wave-machine id="wave-machine"> </wave-machine>
    <nom-mapper id="nom-mapper"> mapper </nom-mapper>
</main>
<footer>
    <div id="controller"> Controller </div>
</footer>
</body>
<script>

function about(){
  const state=document.getElementById("about").style.display;
  if(state==="block"){
     document.getElementById("about").style.display="none";
  }
  if(state==="none"){
     document.getElementById("about").style.display="block";
  }
}

class WaveMachine extends HTMLElement {

    pendula="notset";
    
    constructor() {
        super();
        this.attachShadow({mode: 'open'});                                      
    }

    connectedCallback() {
        //init();
        this.shadowRoot.innerHTML=this.createInnerHtml();
        //this.innerHTML="What up!"  // won't show up!
        //this.shadowRoot.innerHTML="What up!" 
    }

    init(){
       /* slider = document.createElement('nom-slider');
        slider.className="slider-1";
        slider.value=.5;
        slider.label="slider1";
 */
    }

   createInnerHtml(pendula=1){
        return `
          <fieldset>
            <div class="slider">
              <label for="rangeVal">freq:</label>
                <input type ="range" max="1024" min="20"
                  step="1" name="rangeVal" id="wm1" value="200">
                </input>
               <div class="rangeDisplay"></div>
            </div> 
          </fieldset>`
    } 

}

customElements.define('wave-machine', WaveMachine);

class NomMapper extends HTMLElement {
    constructor() {
        super();

        this.input={};
        this.output={};
        this.attachShadow({mode: 'open'}); 

        this.addEventListener('mapper', (evt) => {
            this.input={...evt.detail};
            this.render(this.input,this.output);
        });

        this.addEventListener("mapper", function (evt) {
            let qs=evt.detail.mapToQuerySelector;
            let root = document.querySelector("nom-slider").shadowRoot; 
            let obj=root.querySelector(evt.detail.mapToQuerySelector);
            let mappedVal =evt.detail.value;
            let sendDetail =    { id: evt.timeStamp, 
                                 type:"slider.set",
                                data:mappedVal};

            this.output=sendDetail; 
            this.render(this.input,this.output);
            obj.dispatchEvent( new CustomEvent('slider.set',
                                {detail:sendDetail}));
        });
     }

    connectedCallback(){
         this.render();
    }

    render(inDetail,outDetail) {
         this.shadowRoot.innerHTML ="<h2>Mapper</h2>";
         this.shadowRoot.innerHTML +=
             `detailIn:<pre>${JSON.stringify(inDetail,null,4)}</pre>`;
         this.shadowRoot.innerHTML +=
              `outDetail:<pre>${JSON.stringify(outDetail,null,4)}</pre>`;
         this.shadowRoot.innerHTML += ``;
     } 
}

function stringifyEvent(e) {
  const obj = {};
  for (let k in e) {
    obj[k] = e[k];
  }
  return JSON.stringify(obj, (k, v) => {
    if (v instanceof Node) return 'Node';
    if (v instanceof Window) return 'Window';
    return v;
  }, 4);
}

customElements.define('nom-mapper', NomMapper);

class NomSlider extends HTMLElement {

    constructor() {
        super();
        this.attachShadow({mode: 'open'}); 
        this.mapToQuerySelector="notyet";

        this.template = document.createElement('template');
        this.template.innerHTML = `
<style>
:host {
  display:flex;
  flex-direction: row;
  justify-content: space-between;
}

label {
 text-align:center;
  border: 2px solid red;
  color:red;
  flex 1 0 auto;
}
</style>

  <label></label>
  <input />
  <div id="val"><div>
`;

       this.shadowRoot.appendChild(this.template.content.cloneNode(true));
       this.init();
    }

    connectedCallback(){
    }
  

 
    init() {
        //const input = document.createElement('INPUT');
        const input = this.shadowRoot.querySelector("input"); 
        input.type = 'range';
        input.value = .5;
        input.min =0;
        input.max = 1;
        input.step = .01;
        input.style.width="80%";
        
        //let label=document.createElement('label')
        const label = this.shadowRoot.querySelector("label"); 
        label.innerHTML="lfo";
        label.className="label";

        //let val=document.createElement('span')
        const val = this.shadowRoot.querySelector("#val"); 
        val.innerHTML="0 Hz";
        val.className="rangeDisplay";
        val.style.width="10%";

/* 
The "input" event is sent by a slider (i.e. input DOM element) 
that is a child of this NomSlider.

Reach down into children to grab value of the slider (children[1]) 
and set the value (children[2]) display of this slider to reflect
current value. Should be via inputToValue().

Then send a custom event to the Mapper informing the mapper 
that this slider is changing. This is done by passing a custom
object as the 'detail' item. The detail item is part of the DOM
specification and is how NOM (node object model) objects are passed
between components.
*/
    this.addEventListener("input", (evt) => { 
        // self reflection
        this.shadowRoot.children[2].innerHTML=
            this.shadowRoot.children[1].value;

        // mapToQuerySelector was set when another slider was created.
        // This is what we want mapper to call in the mapper listener.

        document.querySelector('#nom-mapper')
           .dispatchEvent( new CustomEvent('mapper',
               { detail:
                   { id:evt.timeStamp,
                     type:"mapValueToQuerySelector",
                     data:this.value,
                     mapToQuerySelector:this.mapToQuerySelector 
                   }
              }));
        });                                                                       
        // this.shadowRoot.appendChild(label);  // children[0]
        // this.shadowRoot.appendChild(input);  // children[1]
        // this.shadowRoot.appendChild(val);    // children[2]


    


        this.addEventListener( "slider.set", function() {
            this.shadowRoot[1].value=evt.detail.value;
        });
    }

    set value(v) { this.shadowRoot.children[2].innerHTML=v;}
    set id(v) { this.setAttribute('id', v);}
    get value() { return this.shadowRoot.children[1].value; }
    set label(v) { this.shadowRoot.children[0].innerHTML=v;}
//  set mapToQuerySelector(str){ this.mapToQuerySelector=str; }

}

customElements.define('nom-slider', NomSlider);
/* From:
https://github.com/Cortexelus/Polyphonic-Binaural-Beats
*/

function BiBeat() { 
    let oscillators = [];
    function start(){
        oscillators.forEach(o=>o.start());
    }
    function stop(){
        oscillators.forEach(o=>o.stop());
    }
    function init(){
        let ctx = new (window.AudioContext || window.webkitAudioContext)();

        let b = 4 // beat in Hz
        let intervals = [1, 2, 3]; // integer multiples of the fundamental
        let f = 500 // fundamental frequency 

        // Pan
        let panNodes = [ctx.createStereoPanner(),
                        ctx.createStereoPanner()]
        panNodes[0].pan.value = -1;
        panNodes[1].pan.value = 1;
        panNodes[0].connect(ctx.destination);
        panNodes[1].connect(ctx.destination);

        // Oscillators
        for( let i=0; i<intervals.length*2; i++ ) {
            let pan = i%2;
            let o = ctx.createOscillator();
            o.type = 'sine';
            let interval = intervals[Math.floor(i/2)]; 
            if( pan ){
                o.frequency.value = (f + b) * interval;
            }else {
              o.frequency.value = (f + 0) * interval;
            }
    
            //o.start();
            o.connect(panNodes[pan]);
            oscillators.push(o);
        }

    }

    // Set the beat in Hz, the new fundamental frequency,
    // and the new intervals (integer multiples)

    function set( newb, newf, newintervals, vol ) {
        b = newb
        intervals = newintervals
        //bottom_freq = new_bottom_freq
        //smallest_interval = Math.min.apply(null, newintervals); 
        //f = bottom_freq / smallest_interval
        f = newf
        console.log("Fundamental", f, "hz")
        console.log("Beat", b, "hz")
       
        //oscilators=
        //   [osc0left, osc0right,  osc1l, osc1r, osc2l, osc2r ...] 
        //  intervals =
        //    [ 1, 2, 3 ... ]
        for( let i=0; i< oscillators.length; i++ ) {
             let pan = i%2;
             let interval = intervals[ Math.floor( i/2 ) ];
             let harmonic = vol;
             o = oscillators[i];
             if(pan){
                 o.frequency.value = (f + b) * interval * harmonic 
             }else{
                 o.frequency.value = (f + 0) * interval
             }
             console.log(i, o.frequency.value)
        }
    }

    return {
        init:init,
        set:set,
        start:start,
        stop:stop
    }
};

// A beat of 4Hz
// with 200Hz fundamental
// with intervals of 2, 3, 4
// This plays in one ear: 400hz, 600hz, 800hz
// And the other ear: 408hz, 612hz, 816hz
//set(4, 200, [2, 3, 4])
window.addEventListener('load', () => {
    // wavemachine is collection of oscilators with silders
    const wavemachine = document.getElementById("wave-machine");
/*
    slider = document.createElement('nom-slider');
    slider.label="wm1";
    slider.id="wm1";
    slider.shadowRoot.id="wm1";
    wavemachine.shadowRoot.appendChild(slider);

    slider = document.createElement('nom-slider');
    slider.label="wm2";
    slider.id="wm2";
    slider.shadowRoot.id="wm2";
    wavemachine.shadowRoot.appendChild(slider);
*/
    controller = document.querySelector("#controller");
    slider = document.createElement('nom-slider');
    slider.mapToQuerySelector="#wm1";
    removeChildren(controller);
    controller.appendChild(slider);
})

// delete all children
removeChildren = (parent) => {
    while (parent.firstChild) {
       parent.removeChild(parent.firstChild);
    }
}
/* Notes:
    function updatePendulum(evt){
       wavemachine.getRange(0).value=1024*evt.target.value;
       wavemachine.getRange(0).dispatchEvent(new Event('input'));
    }
*/
</script>
</html>
